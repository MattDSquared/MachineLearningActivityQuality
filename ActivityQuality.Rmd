---
title: "Machine Learning - Activity Quality Classification"
author: "MattDSquared"
date: "Wednesday, August 19, 2015"
output: html_document
---
## Executive Summary
Activity monitoring has become a very popular topic in the world of data science. Currently, devices like *Fitbit* and others collect sensor data to determine how *much* exercise someone is doing per day. However little research has shown the *quality* of the exercise being performed. This report explores an example of activity quality classification by predicting common weight lifting mistakes for a barbell lift from a training data set. 

The model used the Random Forest algorithm to train a model which has an expected prediction accuracy of over 99%.

Data and original study comes from the Groupware@LES Human Activity Recognition project:
http://groupware.les.inf.puc-rio.br/har

This document was generated by knitr using code located in this repo: 
https://github.com/MattDSquared/MachineLearningActivityQuality 

## Setup and Libraries Used
```{r setup, message=FALSE}
library(caret)
library(dplyr)
library(randomForest)

set.seed(1433)
```

```{r, echo=FALSE}
setwd("~/../datascience/MachineLearningActivityQuality")
```

```{r download, echo=FALSE}
dir.create("data", showWarnings = FALSE)
filepath.train <- "data/pml-training.csv"
fileURL <- "https://d396qusza40orc.cloudfront.net/predmachlearn/pml-training.csv"
if (!file.exists(filepath.train)) 
    download.file(fileURL, filepath.train)
filepath.test <- "data/pml-testing.csv"
fileURL <- "https://d396qusza40orc.cloudfront.net/predmachlearn/pml-testing.csv"
if (!file.exists(filepath.test)) 
    download.file(fileURL, filepath.test)
```

Data was loaded from downloaded files, and divide-by-zero errors were changed to `NA`. 

```{r load}
rawdat.train <- read.table(filepath.train, header=TRUE, sep=",", quote="\"", 
                           na.strings=c("#DIV/0!","NA"),
                           fill=TRUE,
                           comment.char="",
                           stringsAsFactors=FALSE)
rawdat.test <- read.csv(filepath.test)
```

## Data Cleaning
The data generally form a very tidy data set. Several features contain a very large number of NA values and were therefore removed. Additionally some features required reformatting into factors and dummy variables to assist in R's training algorithms. 

Finally, the time and sample number information was removed since these, on their own, should be useless in predicting real-world activities as it would over fit a model to the particular sequence of these data. Future work could be performed to encapsulate these features to relate to a single weight lifting repetition.

```{r preProcess}
# remove NA heavy features
keepvars <- colSums(is.na(rawdat.train)) < .1*nrow(rawdat.train)
training <- rawdat.train[,keepvars]
testing <- rawdat.test[,keepvars]

# change to factors
training <- mutate(training, 
                   classe = factor(classe),
                   new_window = factor(new_window), 
                   user_name = factor(user_name))

testing <- mutate(testing,
                  new_window = factor(new_window, levels=c("no","yes"), labels=c("no","yes")), 
                  user_name = factor(user_name))

# create dummy variables from factors
dummies.train <- dummyVars(classe ~ user_name + new_window, data=training)
training <- cbind(training, predict(dummies.train, newdata=training))

dummies.test <- dummyVars(problem_id ~ user_name + new_window, data=testing)
testing <- cbind(testing, predict(dummies.test, newdata=testing))

# remove vars which are replaced with dummy variables
# also remove variables that should be poor predictors of the test set, such as
#   sample number and time stamp.
training <- select(training,
                   -user_name, 
                   -new_window, 
                   -X,
                   -raw_timestamp_part_1, 
                   -raw_timestamp_part_2,
                   -cvtd_timestamp)
testing <- select(testing,
                   -user_name, 
                   -new_window, 
                   -X,
                   -raw_timestamp_part_1, 
                   -raw_timestamp_part_2,
                   -cvtd_timestamp)
```

## Subset for cross-validation
Data was subsetted into a training a quizzing data set. The quizzing data set was used to estimate out-of-sample error presented later in this report. If a time variable were re-introduced in this model, a chunked cross-validation method should be used. 

```{r subset}
inTrain <- createDataPartition(training$classe, p=.6, list=FALSE)
quizing <- training[-inTrain,]
training <- training[inTrain,]
```

## Train the Model
A Random Forest model was trained on this partitioned training data set. The Random Forest algorithm was chosen for it robust behavior to correlated data and it's capability in capturing nonlinear relationships. 

While execution time was not a constraint for this problem, future work in covariate creation could utilize a more efficient algorithm. As seen later, this straight forward approach proved sufficient for this analysis. 

```{r train, cache=TRUE}
model <- train(training$classe ~ ., method="rf", 
               data=select(training,-classe))
```

```{r error.estimate}
confMat <- confusionMatrix(quizing$classe, predict(model, select(quizing,-classe)))
print(confMat)
```

## Conclusion
As shown above, the out-of-sample prediction accuracy of `r round(confMat$overall["Accuracy"],3)` was achieved using this method. Even a simply formulated approach to classifying an activity's quality can be very effective. Further research into this field would be a worthwhile venture, particularly in less repetitive exercises than lifting weights. 

## Future work
```{r feat.importance, echo=FALSE, fig.height=6}
varImpPlot(model$finalModel, main="Feature Importance")
```

Considering the `num_window` feature takes the top spot for feature importance in plot above, a re-analysis, excluding `num_window`, to determine accuracy of using accelerometers alone would be useful. 

```{r test.answers, echo=FALSE, results='hide'}
answers <- predict(model, newdata=select(testing,-problem_id))

pml_write_files = function(x){
  n = length(x)
  for(i in 1:n){
    filename = paste0("problem_id_",i,".txt")
    write.table(x[i],file=filename,quote=FALSE,row.names=FALSE,col.names=FALSE)
  }
}
pml_write_files(answers)
```
